<div class="dashboard-container">
  <!-- Header do Dashboard -->
  <div class="dashboard-header" style="margin-bottom: 32px;">
    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">
      <i class="fas fa-satellite-dish" style="color: var(--primary); margin-right: 12px;"></i>
      Painel de Broadcasts
    </h1>
    <p style="color: var(--gray-400);">
      Gerencie todas as suas transmissões de vídeo em um só lugar
    </p>
  </div>
  
  <!-- Estatísticas Rápidas -->
  <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <div class="stat-card" style="background: rgba(67, 97, 238, 0.1); padding: 20px; border-radius: var(--border-radius-sm); border-left: 4px solid var(--primary);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="background: rgba(67, 97, 238, 0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-tv" style="color: var(--primary); font-size: 20px;"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700; color: white;">
            <%= @broadcasts.count %>
          </div>
          <div style="font-size: 14px; color: var(--gray-400);">Broadcasts Totais</div>
        </div>
      </div>
    </div>
    
    <div class="stat-card" style="background: rgba(76, 201, 240, 0.1); padding: 20px; border-radius: var(--border-radius-sm); border-left: 4px solid var(--success);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="background: rgba(76, 201, 240, 0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-play-circle" style="color: var(--success); font-size: 20px;"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700; color: white;">
            <%= @broadcasts.where(status: 'running').count %>
          </div>
          <div style="font-size: 14px; color: var(--gray-400);">Online Agora</div>
        </div>
      </div>
    </div>
    
    <div class="stat-card" style="background: rgba(248, 150, 30, 0.1); padding: 20px; border-radius: var(--border-radius-sm); border-left: 4px solid var(--warning);">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="background: rgba(248, 150, 30, 0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-calendar-check" style="color: var(--warning); font-size: 20px;"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700; color: white;">
            <%= Schedule.count %>
          </div>
          <div style="font-size: 14px; color: var(--gray-400);">Agendamentos</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Barra de Ações -->
  <div class="action-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: rgba(30, 41, 59, 0.8); border-radius: var(--border-radius-sm);">
    <div>
      <h2 style="font-size: 18px; color: white;">Seus Broadcasts</h2>
      <p style="font-size: 13px; color: var(--gray-400); margin-top: 4px;">
        Gerencie e monitore todas as transmissões
      </p>
    </div>
    
    <div style="display: flex; gap: 12px;">
      <!-- Botão Exportar M3U -->
      <%= link_to export_m3u_broadcasts_path,
            class: 'btn btn-secondary',
            style: 'display: flex; align-items: center; gap: 8px;',
            data: { turbo: false } do %>
        <i class="fas fa-list-alt"></i>
        Exportar M3U
      <% end %>
      
      <!-- Botão Configuração -->
      <% streaming_configuration = StreamingConfiguration.find_by(id: 1) %>
      <% if streaming_configuration %>
        <%= link_to edit_streaming_configuration_path(streaming_configuration),
              class: 'btn btn-info',
              style: 'display: flex; align-items: center; gap: 8px;' do %>
          <i class="fas fa-cog"></i>
          Configuração
        <% end %>
      <% else %>
        <%= link_to new_streaming_configuration_path,
              class: 'btn btn-info',
              style: 'display: flex; align-items: center; gap: 8px;' do %>
          <i class="fas fa-cog"></i>
          Configuração
        <% end %>
      <% end %>
      
      <!-- Botão Novo Broadcast -->
      <%= link_to new_broadcast_path, 
            class: 'btn btn-primary',
            style: 'display: flex; align-items: center; gap: 8px;' do %>
        <i class="fas fa-plus"></i>
        Novo Broadcast
      <% end %>
    </div>
  </div>
  
  <!-- Grid de Broadcasts -->
  <div class="broadcasts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-bottom: 48px;">
    
    <% @broadcasts.each do |broadcast| %>
      <div class="broadcast-card" 
           data-broadcast-id="<%= broadcast.id %>"
           style="background: rgba(30, 41, 59, 0.8); border-radius: var(--border-radius); border: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden; transition: var(--transition); position: relative;">
        
        <!-- Header do Card -->
        <div class="card-header" style="padding: 20px; position: relative;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 style="font-weight: 600; color: white; margin-bottom: 4px;">
                <%= broadcast.name %>
              </h3>
              <div class="status-badge <%= broadcast.status == 'running' ? 'online' : 'offline' %>"
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: <%= broadcast.status == 'running' ? 'rgba(76, 201, 240, 0.2)' : 'rgba(247, 37, 133, 0.2)' %>; color: <%= broadcast.status == 'running' ? '#4CC9F0' : '#F72585' %>;">
                <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: <%= broadcast.status == 'running' ? '#4CC9F0' : '#F72585' %>;"></span>
                <%= broadcast.status == 'running' ? 'Online' : 'Offline' %>
              </div>
            </div>
            
            <div class="card-actions" style="display: flex; gap: 8px;">
              <%= button_tag type: 'button',
                    class: 'card-action-btn',
                    style: 'background: rgba(67, 97, 238, 0.2); width: 32px; height: 32px; border-radius: 50%; border: none; color: var(--primary); cursor: pointer; display: flex; align-items: center; justify-content: center;',
                    onclick: "toggleBroadcast(#{broadcast.id})",
                    data: { broadcast_id: broadcast.id } do %>
                <i class="fas fa-<%= broadcast.status == 'running' ? 'pause' : 'play' %>"></i>
              <% end %>
              
              <%= link_to edit_broadcast_path(broadcast),
                    class: 'card-action-btn',
                    style: 'background: rgba(255, 255, 255, 0.1); width: 32px; height: 32px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none;' do %>
                <i class="fas fa-edit"></i>
              <% end %>
            </div>
          </div>
          
          <!-- Indicador de Vídeo -->
          <% if broadcast.video.attached? %>
            <div style="position: absolute; top: 20px; right: 20px;">
              <i class="fas fa-video" style="color: var(--primary);"></i>
            </div>
          <% end %>
        </div>
        
        <!-- Preview do Vídeo -->
        <div class="video-preview" 
             style="background: #0f172a; height: 160px; position: relative;">
          <% if broadcast.video.attached? %>
            <video style="width: 100%; height: 100%; object-fit: cover;"
                   onclick="playPreview(this)">
              <source src="<%= url_for(broadcast.video) %>" type="video/mp4">
            </video>
            <div class="play-overlay" 
                 onclick="playPreview(this.parentElement.querySelector('video'))"
                 style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <div style="background: rgba(255, 255, 255, 0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-play" style="color: white; font-size: 20px;"></i>
              </div>
            </div>
          <% else %>
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gray-500);">
              <i class="fas fa-video-slash" style="font-size: 48px;"></i>
            </div>
          <% end %>
        </div>
        
        <!-- Informações do Broadcast -->
        <div class="card-info" style="padding: 16px 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; font-size: 13px;">
            <div>
              <div style="color: var(--gray-400);">Widgets</div>
              <div style="color: white; font-weight: 500;">
                <%= broadcast.show_widgets ? 'Ativos' : 'Inativos' %>
              </div>
            </div>
            <div>
              <div style="color: var(--gray-400);">Orientação</div>
              <div style="color: white; font-weight: 500;">
                <%= broadcast.orientation == 'portrait' ? 'Retrato' : 'Paisagem' %>
              </div>
            </div>
          </div>
          
          <!-- URL do Stream -->
          <div style="margin-bottom: 16px; font-size: 13px;">
            <div style="color: var(--gray-400); margin-bottom: 4px;">URL do Stream</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <code style="flex: 1; background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 4px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <%= broadcast.stream_url %>
              </code>
              <button onclick="copyToClipboard('<%= broadcast.stream_url %>')"
                      style="background: rgba(67, 97, 238, 0.2); border: none; color: var(--primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          
          <!-- Rodapé com Ações -->
          <div style="display: flex; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <%= form_with(url: start_broadcast_path(broadcast), 
                  method: :post, 
                  local: true,
                  style: 'flex: 1;',
                  data: { turbo: false }) do %>
              <%= button_tag type: 'submit',
                    class: 'btn',
                    style: 'width: 100%; padding: 8px; font-size: 13px; background: rgba(76, 201, 240, 0.2);' do %>
                <i class="fas fa-play"></i> Iniciar
              <% end %>
            <% end %>
            
            <%= form_with(url: stop_broadcast_path(broadcast), 
                  method: :post, 
                  local: true,
                  style: 'flex: 1;',
                  data: { turbo: false }) do %>
              <%= button_tag type: 'submit',
                    class: 'btn',
                    style: 'width: 100%; padding: 8px; font-size: 13px; background: rgba(247, 37, 133, 0.2);' do %>
                <i class="fas fa-stop"></i> Parar
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Card para Novo Broadcast -->
    <div class="new-broadcast-card" 
         onclick="window.location.href='<%= new_broadcast_path %>'"
         style="background: rgba(30, 41, 59, 0.5); border: 2px dashed rgba(255, 255, 255, 0.2); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition);">
      <div style="text-align: center; padding: 40px 20px;">
        <div style="width: 64px; height: 64px; background: rgba(67, 97, 238, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
          <i class="fas fa-plus" style="color: var(--primary); font-size: 24px;"></i>
        </div>
        <h3 style="color: white; margin-bottom: 8px;">Novo Broadcast</h3>
        <p style="color: var(--gray-400); font-size: 14px;">
          Clique para criar uma nova transmissão
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Container de Notificações -->
<div id="notification-container" style="position: fixed; top: 84px; right: 24px; z-index: 9999;"></div>

<script>
  function toggleBroadcast(broadcastId) {
    const card = document.querySelector(`[data-broadcast-id="${broadcastId}"]`);
    const playBtn = card.querySelector('.card-action-btn i');
    const isRunning = playBtn.classList.contains('fa-pause');
    
    if (isRunning) {
      // Parar broadcast
      fetch(`/broadcasts/${broadcastId}/stop`, { 
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      })
      .then(response => {
        if (response.ok) {
          playBtn.classList.replace('fa-pause', 'fa-play');
          const statusBadge = card.querySelector('.status-badge');
          statusBadge.style.background = 'rgba(247, 37, 133, 0.2)';
          statusBadge.style.color = '#F72585';
          statusBadge.innerHTML = '<span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #F72585;"></span> Offline';
          showNotification('Broadcast parado com sucesso', 'success');
        } else {
          showNotification('Erro ao parar o broadcast', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Erro de conexão', 'error');
      });
    } else {
      // Iniciar broadcast
      fetch(`/broadcasts/${broadcastId}/start`, { 
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      })
      .then(response => {
        if (response.ok) {
          playBtn.classList.replace('fa-play', 'fa-pause');
          const statusBadge = card.querySelector('.status-badge');
          statusBadge.style.background = 'rgba(76, 201, 240, 0.2)';
          statusBadge.style.color = '#4CC9F0';
          statusBadge.innerHTML = '<span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #4CC9F0;"></span> Online';
          showNotification('Broadcast iniciado com sucesso', 'success');
        } else {
          showNotification('Erro ao iniciar o broadcast', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Erro de conexão', 'error');
      });
    }
  }
  
  function playPreview(videoElement) {
    if (videoElement.paused) {
      videoElement.play();
      videoElement.controls = true;
      videoElement.parentElement.querySelector('.play-overlay').style.display = 'none';
    }
  }
  
  function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
    const bgColor = type === 'success' ? 'rgba(76, 201, 240, 0.9)' : 
                   type === 'error' ? 'rgba(247, 37, 133, 0.9)' : 
                   'rgba(67, 97, 238, 0.9)';
    
    notification.innerHTML = `
      <div style="background: ${bgColor}; color: white; padding: 12px 20px; border-radius: var(--border-radius-sm); margin-bottom: 12px; box-shadow: var(--shadow); min-width: 300px; backdrop-filter: blur(10px); animation: slideIn 0.3s ease;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 20px;">${icon}</span>
          <div>
            <div style="font-weight: 500;">${message}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
              ${new Date().toLocaleTimeString()}
            </div>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(notification);
    
    // Remover após 5 segundos
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      showNotification('URL copiada para a área de transferência!', 'success');
    }).catch(err => {
      console.error('Erro ao copiar: ', err);
      showNotification('Erro ao copiar a URL', 'error');
    });
  }
</script>

<style>
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  .broadcast-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  .new-broadcast-card:hover {
    background: rgba(30, 41, 59, 0.8);
    border-color: var(--primary);
    transform: translateY(-4px);
  }
  
  .card-action-btn:hover {
    transform: scale(1.1);
  }

  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    font-size: 14px;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: rgba(67, 97, 238, 0.9);
  }
  
  .btn-secondary {
    background: var(--secondary);
    color: white;
  }
  
  .btn-secondary:hover {
    background: rgba(100, 116, 139, 0.9);
  }
  
  .btn-info {
    background: var(--info);
    color: white;
  }
  
  .btn-info:hover {
    background: rgba(76, 201, 240, 0.9);
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
</style>