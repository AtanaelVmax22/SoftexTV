

<h1><%= I18n.t('Edit Broadcast') %></h1>

<div class="broadcasts-container-edit">
  <div class="broadcast-card-desktop-edit mirror-effect" data-broadcast-id="desktop">
    <%= form_with(model: @broadcast, local: true, class: 'edit-broadcast-form', html: { id: 'broadcast-form' }) do |form| %>
      <% if @broadcast.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(@broadcast.errors.count, "error") %> prohibited this broadcast from being saved:</h2>
          <ul>
            <% @broadcast.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="shadow-effect"></div>
      <div class="upload-desktop">
        <div class="field">
          <%= form.label :name %>
          <%= form.text_field :name, value: @broadcast.name, class: 'input-field' %>
        </div>
        
        <div class="field">
          <%= form.label :video %>
          <%= form.file_field :video, class: 'input-field' %>
        </div>

        <!-- BOT츾O "AGENDAR V칈DEOS" DENTRO DO FORM, MAS N츾O ENVIA O FORMUL츼RIO -->
        <div class="field">
          <button type="button" id="open-timeline" class="timeline-btn">Schedule Videos</button>
        </div>

        <div class="field">
          <%= form.label :show_widgets, 'Show Widgets' %>
          <%= form.check_box :show_widgets %>
        </div>

        <div class="field">
          <%= form.label :orientation, 'Orienta칞칚o da Tela' %>
          <%= form.select :orientation, options_for_select([['Retrato', 'portrait'], ['Paisagem', 'landscape']], @broadcast.orientation), {}, class: 'input-field' %>
        </div>

        <!-- BOT츾O DE SUBMISS츾O DO FORMUL츼RIO -->
        <div class="actions">
          <%= form.submit I18n.t('Update Broadcast'), class: 'submit-btn' %>
        </div>
      </div>
    <% end %>

    <%= form_with model: @broadcast, method: :delete, data: { confirm: 'Are you sure you want to delete this broadcast?' } do |form| %>
      <%= form.submit 'X', class: 'delete-btn' %>
    <% end %>
  </div>
</div>

<!-- MODAL -->
<div id="timeline-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-modal" id="close-timeline">&times;</span>
    <h2>Agendamento de V칤deos</h2>

    <div class="field">
      <label>Selecione o per칤odo:</label>
      <input type="text" id="date-range" class="input-field" placeholder="Escolha a data">
      <button id="add-period" class="add-period-btn">Adicionar Per칤odo</button>
    </div>

    <div id="period-list"></div>
  </div>
</div>





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css">
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet" />

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("timeline-modal");
  const openModalBtn = document.getElementById("open-timeline");
  const closeModalBtn = document.getElementById("close-timeline");

  // Abre o modal ao clicar no bot칚o "Agendar V칤deos"
  openModalBtn.addEventListener("click", function () {
    modal.style.display = "flex";
  });

  // Fecha o modal ao clicar no bot칚o de fechar
  closeModalBtn.addEventListener("click", function () {
    modal.style.display = "none";
  });

  // Fecha o modal ao clicar fora dele
  window.addEventListener("click", function (event) {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });
});


document.addEventListener("DOMContentLoaded", function() {
  const broadcastForm = document.getElementById("broadcast-form");

  if (broadcastForm) {
    broadcastForm.addEventListener("submit", async function(event) {
      event.preventDefault(); // Impede envio imediato

      const formData = new FormData();
      const broadcastId = "<%= @broadcast.id %>";
      let hasData = false;

      document.querySelectorAll(".period-item").forEach((item, index) => {
        const periodInput = item.querySelector("input[type='hidden']");
        const videoInput = item.querySelector("input[type='file']");

        // 丘멆잺 Verifica se os elementos existem antes de acessar seus valores
        if (!periodInput || !videoInput) return;

        const period = periodInput.value;
        const video = videoInput.files[0];

        // 丘멆잺 Garante que apenas per칤odos com v칤deos sejam enviados
        if (!period || !video) return;

        const [start, end] = period.split(" - ");
        const startDate = moment(start, "DD/MM/YYYY").format("YYYY-MM-DD");
        const endDate = moment(end, "DD/MM/YYYY").format("YYYY-MM-DD");

        formData.append(`schedules[${index}][start_date]`, startDate);
        formData.append(`schedules[${index}][end_date]`, endDate);
        formData.append(`schedules[${index}][video]`, video);
        formData.append(`schedules[${index}][broadcast_id]`, broadcastId);

        hasData = true;
      });

      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      try {
        if (hasData) {
          const response = await fetch("/schedules/bulk_create", {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRF-Token": csrfToken
            }
          });
          
          if (!response.ok) {
            const text = await response.text();
            throw new Error("Erro inesperado: " + text);
          }
          
        }

        // Agora submete o formul치rio de fato
        broadcastForm.submit();

      } catch (error) {
        alert("Erro ao salvar: " + error.message);
        console.error(error);
      }
    });
  }
});


document.addEventListener("DOMContentLoaded", function() {
  let removedScheduleIds = [];

  const picker = new Litepicker({
    element: document.getElementById('date-range'),
    singleMode: false,
    numberOfMonths: 1,
    numberOfColumns: 1,
    format: 'DD/MM/YYYY',
    allowRepick: true,
    minDate: new Date()
  });

  let periods = [];

  document.getElementById("add-period").addEventListener("click", function () {
    const dateInput = document.getElementById("date-range").value;
    if (dateInput === "") {
      alert("Selecione um per칤odo antes de adicionar.");
      return;
    }
  
    const periodId = `period-${periods.length}`;
    const [start, end] = dateInput.split(" - ");
    const startDate = moment(start, "DD/MM/YYYY").format("DD/MM/YYYY");
    const endDate = moment(end, "DD/MM/YYYY").format("DD/MM/YYYY");
  
    const periodHTML = `
      <div class="period-item" id="${periodId}">
        <strong>Per칤odo:</strong> ${startDate} - ${endDate}
        <input type="hidden" name="periods[]" value="${startDate} - ${endDate}">
        <input type="file" name="videos[]" class="video-upload" accept="video/*">
        <button class="remove-period" onclick="removePeriod('${periodId}')">Remover</button>
      </div>
    `;
  
    document.getElementById("period-list").insertAdjacentHTML("beforeend", periodHTML);
    periods.push(dateInput);
    document.getElementById("date-range").value = "";
  });
  

  window.removePeriod = function(periodId, scheduleId = null) {
  const element = document.getElementById(periodId);
  element.remove();

  if (scheduleId) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch("/schedules/destroy_schedule", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": csrfToken
      },
      body: JSON.stringify({ id: scheduleId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert("Erro ao excluir: " + data.error);
      } else {
        console.log("Agendamento removido com sucesso");
      }
    })
    .catch(err => {
      console.error("Erro ao excluir:", err);
    });
  }
};



  document.getElementById("save-all").addEventListener("click", function() {
    
  const formData = new FormData();
  const broadcastId = "<%= @broadcast.id %>";
  if (removedScheduleIds.length > 0) {
    removedScheduleIds.forEach(id => {
      formData.append("removed_ids[]", id);
    });
  }
  let hasData = false;

  
  document.querySelectorAll(".period-item").forEach((item, index) => {
    const period = item.querySelector("input[type='hidden']").value;
    const video = item.querySelector("input[type='file']").files[0];

    if (!period || !video) {
      alert("Cada per칤odo deve ter um v칤deo associado!");
      return;
    }

    const [start, end] = period.split(" - ");
    const startDate = moment.utc(schedule.start).format("DD/MM/YYYY");
    const endDate = moment.utc(schedule.end).format("DD/MM/YYYY");
    

    formData.append(`schedules[${index}][start_date]`, startDate);
    formData.append(`schedules[${index}][end_date]`, endDate);
    formData.append(`schedules[${index}][video]`, video);
    formData.append(`schedules[${index}][broadcast_id]`, broadcastId);

    hasData = true;
  });

  if (!hasData) {
    alert("Nenhum per칤odo foi adicionado!");
    return;
  }

  // Pegando o token CSRF do HTML
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  fetch("/schedules/bulk_create", {
    method: "POST",
    body: formData,
    headers: {
      "X-CSRF-Token": csrfToken // Adicionando o token CSRF no cabe칞alho
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert("Erro ao salvar: " + data.error);
    } else {
      alert("Per칤odos e v칤deos salvos com sucesso!");
      location.reload();
    }
  })
  .catch(error => {
    console.error("Erro ao salvar:", error);
    alert("Erro ao enviar os dados. Veja o console para mais detalhes.");
  });
});


});

window.updateVideoName = function(input) {
  const span = input.parentElement.querySelector(".video-name");
  const fileName = input.files[0]?.name || "Nenhum v칤deo selecionado";
  span.textContent = `游꿘 ${fileName}`;
}



document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("timeline-modal");
  const openModalBtn = document.getElementById("open-timeline");
  const closeModalBtn = document.getElementById("close-timeline");

  // Abre o modal ao clicar no bot칚o "Agendar V칤deos"
  openModalBtn.addEventListener("click", function () {
    modal.style.display = "flex";
  });

  // Fecha o modal ao clicar no bot칚o de fechar
  closeModalBtn.addEventListener("click", function () {
    modal.style.display = "none";
  });

  // Fecha o modal ao clicar fora dele
  window.addEventListener("click", function (event) {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

  const periodList = document.getElementById("period-list");
  const existingSchedules = <%= @schedules.to_json.html_safe %>;

  existingSchedules.forEach(schedule => {
    const startDate = moment.utc(schedule.start).format("DD/MM/YYYY");
    const endDate = moment.utc(schedule.end).format("DD/MM/YYYY");
    
    const videoName = schedule.video ? schedule.video.split('/').pop() : 'Nenhum v칤deo';
    const periodId = `period-${schedule.id}`;

    const periodHTML = `
      <div class="period-item" id="${periodId}">
        <strong>Per칤odo:</strong> ${startDate} - ${endDate} | 游꿘 <strong>V칤deo:</strong> ${videoName}
        <div>
          <input type="file" name="videos[]" class="video-upload" accept="video/*">
          <button class="remove-period" onclick="removePeriod('${periodId}', ${schedule.id})">Remover</button>
        </div>
      </div>
    `;

    periodList.insertAdjacentHTML("beforeend", periodHTML);
  });
});



// Atualiza o nome do v칤deo quando um novo arquivo 칠 selecionado
window.updateVideoName = function(input, periodId) {
  const fileName = input.files[0] ? input.files[0].name : "Nenhum v칤deo selecionado";
  const periodElement = document.getElementById(periodId);
  const videoNameElement = periodElement.querySelector(".video-name");

  if (videoNameElement) {
    videoNameElement.textContent = `游꿘 ${fileName}`;
  }
};








  $(document).ready(function() {
    // Inicializa o calend치rio
    $('#calendar').fullCalendar({
      events: '/broadcasts/events', // URL para buscar os eventos
      editable: true, // Permite edi칞칚o
      droppable: true, // Permite arrastar e soltar
      eventDrop: function(event, delta, revertFunc) {
        // Atualiza o evento quando arrastado
        $.ajax({
          url: '/broadcasts/update_event', // Atualiza evento no backend
          method: 'PATCH',
          data: {
            event_id: event.id,
            start: event.start.format(),
            end: event.end.format()
          },
          success: function(response) {
            alert('Event updated successfully!');
          }
        });
      },
      eventClick: function(event) {
        // Exibe mais detalhes ao clicar no evento
        alert('Event clicked: ' + event.title);
      }
    });

    // Exibe ou esconde o calend치rio quando o checkbox "Agendar" for marcado
    $('#schedule_checkbox').change(function() {
      if ($(this).is(':checked')) {
        $('#calendar_field').show();  // Exibe o calend치rio
      } else {
        $('#calendar_field').hide();  // Esconde o calend치rio
      }
    });
  });
</script>

<style> 

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  position: relative;
}

.close-modal {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 24px;
  cursor: pointer;
}

.timeline-btn {
  margin: 10px;
  padding: 8px 15px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.timeline-btn:hover {
  background-color: #0056b3;
}


.add-period-btn {
  margin: 10px 0;
  padding: 8px 15px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.add-period-btn:hover {
  background-color: #0056b3;
}

.period-item {
  background: #f4f4f4;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
}

.remove-period {
  background: red;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 5px;
  float: right;
}

.litepicker {
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.litepicker .container__months {
  display: flex;
  justify-content: center;
}

.litepicker .month-item {
  padding: 10px;
}

.litepicker .day-item {
  border-radius: 50%;
  width: 36px;
  height: 36px;
  line-height: 36px;
  font-size: 16px;
}

.litepicker .day-item.is-start-date,
.litepicker .day-item.is-end-date {
  background-color: navy;
  color: white;
}

.litepicker .day-item.is-in-range {
  background-color: rgba(0, 0, 139, 0.2);
  border-radius: 20px;
}



.broadcast-card-desktop-edit {
    position: relative;
    padding: 0;
    background-image: url(/assets/off.png);
    background-size: 240px 400px;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 240px;
    height: 469px;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    top: 19px;
}
#calendar_field
{
position: fixed;
    width: 311px;
    top: 195px;
    right: 110px;
    background: white;
    padding: 14px;
    z-index: 306;
    border-radius: 0px 25px 25px 0px;
    }
.delete-btn {
    color: #ffffff;
    font-weight: bold;
    text-decoration: none;
    margin: 0;
    position: absolute;
    z-index: 1;
    top: 0;
    font-size: 34px;
    background-color: red;
    border: 0;
    border-radius: 7px 0;
}

.delete-btn:hover {
  color: darkred;
  text-decoration: underline;
}

.broadcasts-container-edit {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    flex-direction: row;
    align-content: center;
    align-items: stretch;
    color: white;
    margin-top: 122px;

}

.shadow-effect {
    border-radius: 5px;
    width: -webkit-fill-available;
    height: -webkit-fill-available;
    position: absolute;
    background: linear-gradient(to top, rgb(0 0 0 / 97%) 0%, rgb(255 255 255 / 0%) 100%);
}

body {
    font-family: Arial, sans-serif;
    background-color: #f3f4f6;
    margin: auto;
    display: flex;
    justify-content: center;
    height: 100vh;
    flex-direction: column;
}

h1 {
    text-align: center;
    color: #ffffff;
    top: 0;
    position: absolute;
    width: -webkit-fill-available;
    background-color: #a4a5ab;
    padding: 27px;
    margin: 0;
    height: 60px;
}
h1::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 50%;
  transform: translateX(-50%);
  width: -webkit-fill-available;
  height: 3px;
  background: radial-gradient(circle at center top, rgb(255 111 0) 0%, transparent 70%);
  pointer-events: none;
  z-index: 1;
}
  
.field {
  margin-bottom: 20px;
}

.input-field {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 16px;
}

.submit-btn {
  width: 100%;
  padding: 10px;
  background-color: #45a049;
  color: white;
  font-size: 18px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.submit-btn:hover {
  background-color: #387a3e;
}

.field {
  text-shadow: 0 0 10px rgb(0 0 0);
}
</style>
