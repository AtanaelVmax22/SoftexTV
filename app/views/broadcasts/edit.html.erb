<div class="edit-broadcast-view">
  <div class="grid grid-cols-2" style="gap: 32px; min-height: calc(100vh - 160px);">
    
    <!-- COLUNA ESQUERDA: CONFIGURA√á√ÉO -->
    <div class="space-y-6">
      <!-- Card de Configura√ß√£o Principal -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìù Configura√ß√£o do Broadcast</h2>
          <div class="status-badge <%= @broadcast.status == 'running' ? 'online' : 'offline' %>">
            <span class="status-dot"></span>
            <%= @broadcast.status == 'running' ? 'Online' : 'Offline' %>
          </div>
        </div>
        
        <div class="card-body">
          <%= form_with(model: @broadcast, local: true, class: 'broadcast-form', 
              html: { id: 'broadcast-form', autocomplete: 'off' }) do |form| %>
            
            <% if @broadcast.errors.any? %>
              <div class="error-message" style="background: rgba(247, 37, 133, 0.1); 
                    border-left: 4px solid var(--danger); padding: 16px; 
                    border-radius: var(--border-radius-sm); margin-bottom: 24px;">
                <h3 style="color: var(--danger); margin-bottom: 8px;">
                  <%= pluralize(@broadcast.errors.count, "erro") %> encontrado(s):
                </h3>
                <ul style="color: #fecdd3; font-size: 14px;">
                  <% @broadcast.errors.full_messages.each do |message| %>
                    <li>‚Ä¢ <%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <!-- Nome do Broadcast -->
            <div class="form-group">
              <label class="form-label">Nome do Broadcast</label>
              <%= form.text_field :name, 
                  class: 'form-input',
                  placeholder: 'Ex: TV Sala de Reuni√µes',
                  value: @broadcast.name %>
            </div>
            
            <!-- Upload do V√≠deo Principal -->
            <div class="form-group">
              <label class="form-label">V√≠deo Principal</label>
              <div class="upload-area" onclick="document.getElementById('video-upload').click()">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text">Arraste e solte o arquivo de v√≠deo</p>
                <p class="upload-note">ou clique para selecionar</p>
                <% if @broadcast.video.attached? %>
                  <div style="margin-top: 16px; padding: 12px; background: rgba(76, 201, 240, 0.1); 
                       border-radius: var(--border-radius-sm);">
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                    <span style="color: #bae6fd;">
                      <%= @broadcast.video.filename %> 
                      (<%= number_to_human_size(@broadcast.video.byte_size) %>)
                    </span>
                  </div>
                <% end %>
                <%= form.file_field :video, 
                    id: 'video-upload', 
                    class: 'd-none',
                    accept: 'video/*',
                    onchange: 'updateFileName(this)' %>
              </div>
            </div>
            
            <!-- Op√ß√µes de Exibi√ß√£o -->
            <div class="form-group">
              <div class="toggle-switch">
                <%= form.check_box :show_widgets, class: 'toggle-input' %>
                <span class="toggle-slider"></span>
                <span class="toggle-label" style="color: #cbd5e1;">Mostrar Widgets na Transmiss√£o</span>
              </div>
            </div>
            
            <!-- Orienta√ß√£o da Tela -->
            <div class="form-group">
              <label class="form-label">Orienta√ß√£o da Tela</label>
              <div class="orientation-toggle" style="display: flex; gap: 12px;">
                <label class="orientation-option" 
                       style="flex: 1; text-align: center; cursor: pointer;">
                  <input type="radio" name="broadcast[orientation]" 
                         value="portrait" 
                         <%= 'checked' if @broadcast.orientation == 'portrait' %>
                         class="d-none"
                         onchange="toggleOrientation(this)">
                  <div class="orientation-preview <%= 'active' if @broadcast.orientation == 'portrait' %>"
                       style="padding: 20px; border: 2px solid transparent; 
                              border-radius: var(--border-radius-sm); 
                              background: rgba(15, 23, 42, 0.5);">
                    <div style="width: 40px; height: 70px; margin: 0 auto; 
                         background: <%= @broadcast.orientation == 'portrait' ? 'var(--primary)' : '#475569' %>; 
                         border-radius: 4px;"></div>
                    <p style="margin-top: 12px; color: <%= @broadcast.orientation == 'portrait' ? 'white' : '#94a3b8' %>;">
                      Retrato
                    </p>
                  </div>
                </label>
                
                <label class="orientation-option" 
                       style="flex: 1; text-align: center; cursor: pointer;">
                  <input type="radio" name="broadcast[orientation]" 
                         value="landscape" 
                         <%= 'checked' if @broadcast.orientation == 'landscape' %>
                         class="d-none"
                         onchange="toggleOrientation(this)">
                  <div class="orientation-preview <%= 'active' if @broadcast.orientation == 'landscape' %>"
                       style="padding: 20px; border: 2px solid transparent; 
                              border-radius: var(--border-radius-sm); 
                              background: rgba(15, 23, 42, 0.5);">
                    <div style="width: 70px; height: 40px; margin: 0 auto; 
                         background: <%= @broadcast.orientation == 'landscape' ? 'var(--primary)' : '#475569' %>; 
                         border-radius: 4px;"></div>
                    <p style="margin-top: 12px; color: <%= @broadcast.orientation == 'landscape' ? 'white' : '#94a3b8' %>;">
                      Paisagem
                    </p>
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div style="display: flex; gap: 12px; margin-top: 32px;">
              <%= form.submit 'üíæ Salvar Altera√ß√µes', 
                  class: 'btn btn-primary',
                  style: 'flex: 1;',
                  data: { disable_with: 'Salvando...' } %>
              
              <button type="button" 
                      onclick="openScheduleModal()"
                      class="btn btn-secondary"
                      style="flex: 1;">
                <i class="fas fa-calendar-alt"></i>
                Agendar V√≠deos
              </button>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Zona de Perigo -->
      <div class="card" style="border-color: var(--danger); background: rgba(247, 37, 133, 0.05);">
        <div class="card-header">
          <h2 class="card-title" style="color: var(--danger);">
            ‚ö†Ô∏è Zona de Perigo
          </h2>
        </div>
        <div class="card-body">
          <p style="color: #fecdd3; margin-bottom: 20px; font-size: 14px;">
            Esta a√ß√£o √© irrevers√≠vel. Ao excluir este broadcast, todos os agendamentos 
            e configura√ß√µes ser√£o permanentemente removidos.
          </p>
          <%= button_to 'üóëÔ∏è Excluir Broadcast', 
                broadcast_path(@broadcast), 
                method: :delete, 
                class: 'btn btn-danger',
                style: 'width: 100%;',
                data: { 
                  confirm: 'Tem certeza que deseja excluir este broadcast?',
                  turbo_confirm: 'Tem certeza que deseja excluir este broadcast?'
                } %>
        </div>
      </div>
    </div>
    
    <!-- COLUNA DIREITA: PREVIEW -->
    <div class="space-y-6">
      <!-- Preview do V√≠deo -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üì∫ Preview ao Vivo</h2>
          <div style="display: flex; gap: 8px;">
            <%= form_with(url: start_broadcast_path(@broadcast), method: :post, local: true) do %>
              <%= button_tag type: 'submit', 
                    class: 'btn',
                    style: 'padding: 6px 12px; font-size: 12px; background: rgba(76, 201, 240, 0.2);' do %>
                <i class="fas fa-play"></i> Iniciar
              <% end %>
            <% end %>
            
            <%= form_with(url: stop_broadcast_path(@broadcast), method: :post, local: true) do %>
              <%= button_tag type: 'submit', 
                    class: 'btn',
                    style: 'padding: 6px 12px; font-size: 12px; background: rgba(247, 37, 133, 0.2);' do %>
                <i class="fas fa-stop"></i> Parar
              <% end %>
            <% end %>
          </div>
        </div>
        
        <div class="card-body">
          <div class="video-preview-container" 
               style="background: #0f172a; border-radius: var(--border-radius-sm); 
                      overflow: hidden; aspect-ratio: 16/9;">
            <% if @broadcast.video.attached? %>
              <video id="preview-player"
                     class="video-js vjs-default-skin"
                     controls
                     preload="metadata"
                     style="width: 100%; height: 100%;">
                <source src="<%= url_for(@broadcast.video) %>" type="<%= @broadcast.video.content_type %>">
              </video>
            <% else %>
              <div style="display: flex; align-items: center; justify-content: center; 
                   height: 100%; color: #64748b; text-align: center;">
                <div>
                  <i class="fas fa-video-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
                  <p>Nenhum v√≠deo carregado</p>
                  <p style="font-size: 12px; color: #475569;">
                    Fa√ßa upload de um v√≠deo para visualizar
                  </p>
                </div>
              </div>
            <% end %>
          </div>
          
          <!-- Informa√ß√µes T√©cnicas -->
          <div style="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.5); 
               border-radius: var(--border-radius-sm); font-size: 13px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div>
                <span style="color: #94a3b8;">ID:</span>
                <span style="color: white; font-family: monospace;"><%= @broadcast.id %></span>
              </div>
              <div>
                <span style="color: #94a3b8;">Criado em:</span>
                <span><%= @broadcast.created_at.strftime('%d/%m/%Y %H:%M') %></span>
              </div>
              <div>
                <span style="color: #94a3b8;">Stream URL:</span>
                <span style="color: #bae6fd; font-family: monospace; font-size: 12px;">
                  <%= truncate(@broadcast.stream_url, length: 25) %>
                </span>
              </div>
              <div>
                <span style="color: #94a3b8;">√öltima atualiza√ß√£o:</span>
                <span><%= time_ago_in_words(@broadcast.updated_at) %> atr√°s</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Agendamentos Ativos -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìÖ Agendamentos Ativos</h2>
          <span class="badge" style="background: rgba(76, 201, 240, 0.2); color: var(--success); 
                padding: 4px 8px; border-radius: 12px; font-size: 12px;">
            <%= @schedules.count %> ativo(s)
          </span>
        </div>
        
        <div class="card-body">
          <% if @schedules.any? %>
            <div class="schedules-list" style="max-height: 300px; overflow-y: auto;">
              <% @schedules.each do |schedule| %>
                <div class="schedule-item" 
                     style="padding: 12px; background: rgba(15, 23, 42, 0.5); 
                            border-radius: var(--border-radius-sm); margin-bottom: 8px;
                            border-left: 4px solid var(--success);">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong style="color: white; font-size: 14px;">
                        <%= schedule.start.strftime('%d/%m/%Y') %> ‚Üí <%= schedule.end.strftime('%d/%m/%Y') %>
                      </strong>
                      <p style="color: #94a3b8; font-size: 12px; margin-top: 4px;">
                        <%= schedule.video.filename if schedule.video.attached? %>
                      </p>
                    </div>
                    <button onclick="removeSchedule(<%= schedule.id %>)" 
                            class="btn"
                            style="padding: 4px 8px; font-size: 12px; background: rgba(247, 37, 133, 0.2);">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div style="text-align: center; padding: 40px 20px; color: #64748b;">
              <i class="fas fa-calendar-plus" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>Nenhum agendamento configurado</p>
              <p style="font-size: 13px; margin-top: 8px;">
                Clique em "Agendar V√≠deos" para configurar per√≠odos de exibi√ß√£o
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal de Agendamento (ser√° renderizado via JavaScript) -->
  <div id="schedule-modal" style="display: none;"></div>
</div>

<script>
  // Fun√ß√µes JavaScript para interatividade
  function openScheduleModal() {
    // Carregar o modal via AJAX
    fetch('<%= schedule_modal_broadcast_path(@broadcast) %>')
      .then(response => response.text())
      .then(html => {
        document.getElementById('schedule-modal').innerHTML = html;
        document.getElementById('schedule-modal').style.display = 'flex';
        initializeScheduleModal();
      });
  }
  
  function toggleOrientation(radio) {
    document.querySelectorAll('.orientation-preview').forEach(el => {
      el.classList.remove('active');
      el.style.borderColor = 'transparent';
    });
    
    radio.parentElement.querySelector('.orientation-preview').classList.add('active');
    radio.parentElement.querySelector('.orientation-preview').style.borderColor = 'var(--primary)';
  }
  
  function updateFileName(input) {
    if (input.files.length > 0) {
      const fileName = input.files[0].name;
      const uploadArea = input.closest('.upload-area');
      uploadArea.innerHTML = `
        <i class="fas fa-check-circle upload-icon" style="color: var(--success);"></i>
        <p class="upload-text">${fileName}</p>
        <p class="upload-note">Clique para alterar</p>
        <input type="file" id="video-upload" class="d-none" 
               accept="video/*" onchange="updateFileName(this)">
      `;
    }
  }
  
  function removeSchedule(scheduleId) {
    if (confirm('Remover este agendamento?')) {
      fetch('/schedules/destroy_schedule', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ id: scheduleId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      });
    }
  }
  
  // Estiliza√ß√£o din√¢mica
  document.addEventListener('DOMContentLoaded', function() {
    // Marcar orienta√ß√£o ativa
    document.querySelectorAll('input[name="broadcast[orientation]"]:checked').forEach(radio => {
      radio.parentElement.querySelector('.orientation-preview').style.borderColor = 'var(--primary)';
    });
    
    // Inicializar player de preview
    if (document.getElementById('preview-player')) {
      const player = videojs('preview-player', {
        fluid: true,
        controls: true,
        autoplay: false,
        preload: 'metadata'
      });
    }
  });
</script>

<style>
  /* Estilos espec√≠ficos para a view de edi√ß√£o */
  .edit-broadcast-view {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .d-none {
    display: none !important;
  }
  
  .space-y-6 > * + * {
    margin-top: 24px;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .schedules-list::-webkit-scrollbar {
    width: 6px;
  }
  
  .schedules-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }
  
  .schedules-list::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
  }
</style>